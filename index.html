<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>IpaVip Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBRmKbekcv6OW8oaMsHPlc8WvfIWnyFAI0",
      authDomain: "appgamesrepo.firebaseapp.com",
      databaseURL: "https://appgamesrepo-default-rtdb.firebaseio.com",
      projectId: "appgamesrepo",
      storageBucket: "appgamesrepo.appspot.com",
      messagingSenderId: "220298514248",
      appId: "1:220298514248:web:f3193a6042d3e1a67a6d7d",
      measurementId: "G-0YVBYHKG2D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const form = document.getElementById('appForm');
    const output = document.getElementById('appsList');
    const repoSelect = document.getElementById('repoType');
    const vipSettings = document.getElementById('vipSettings');
    const tokenOutput = document.getElementById('tokenOutput');
    let editKey = null;

    repoSelect.addEventListener('change', () => {
      vipSettings.style.display = repoSelect.value === 'vipApps' ? 'block' : 'none';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const appData = {
        name: form.name.value,
        type: 1,
        bundleID: form.bundleID.value,
        bundleIdentifier: form.bundleID.value,
        version: form.version.value,
        size: parseInt(form.size.value),
        down: form.downloadURL.value,
        downloadURL: form.downloadURL.value,
        developerName: "",
        localizedDescription: form.description.value,
        icon: form.iconURL.value,
        iconURL: form.iconURL.value,
        appUpdateTime: new Date().toISOString()
      };

      const repo = repoSelect.value;
      const path = `${repo}/apps`;

      if (editKey) {
        await update(ref(db, `${path}/${editKey}`), appData);
        editKey = null;
      } else {
        await push(ref(db, path), appData);
      }

      if (repo === 'vipApps') {
        const token = Math.random().toString(36).substring(2, 12);
        const expireDate = new Date(form.expireDate.value).toISOString();

        await set(ref(db, `vipTokens/${token}`), {
          createdAt: new Date().toISOString(),
          expiresAt: expireDate
        });

        tokenOutput.innerHTML = `
          <h3>‚úÖ VIP —Ç–æ–∫–µ–Ω —Å–æ–∑–¥–∞–Ω</h3>
          <p><b>üîë –¢–æ–∫–µ–Ω:</b> <code>${token}</code></p>
          <p><b>üìÖ –ò—Å—Ç–µ–∫–∞–µ—Ç:</b> ${expireDate}</p>
          <p><b>üì• GBox JSON:</b><br>
          <a href="https://api-u3vwde53ja-uc.a.run.app/vipRepo?token=${token}" target="_blank">
            https://api.../vipRepo?token=${token}
          </a></p>`;
      } else {
        tokenOutput.innerHTML = '';
      }

      form.reset();
      vipSettings.style.display = 'none';
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è vip)
    onValue(ref(db, 'apps'), (snapshot) => {
      output.innerHTML = '<h2>üì± –û–±—ã—á–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>';
      snapshot.forEach(child => {
        const app = child.val();
        const appDiv = document.createElement('div');
        appDiv.className = 'appCard';
        appDiv.innerHTML = `
          <img src="${app.iconURL}" width="48" height="48">
          <strong>${app.name}</strong> (${app.version})<br>
          <small>${app.bundleID}</small><br>
          <button class="editBtn" data-id="${child.key}">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="deleteBtn" onclick="deleteApp('${child.key}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        `;
        output.appendChild(appDiv);

        appDiv.querySelector('.editBtn').addEventListener('click', () => {
          form.name.value = app.name;
          form.bundleID.value = app.bundleID;
          form.version.value = app.version;
          form.size.value = app.size;
          form.downloadURL.value = app.downloadURL;
          form.iconURL.value = app.iconURL;
          form.description.value = app.localizedDescription;
          editKey = child.key;
        });
      });
    });

    window.deleteApp = function (key) {
      remove(ref(db, 'apps/' + key));
    };
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #ffcc00;
    }
    form, #appsList, #tokenOutput {
      background: #222;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      margin: 0 auto 20px;
    }
    input, textarea, select {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      border: none;
      border-radius: 5px;
    }
    button {
      padding: 10px 20px;
      background: #ffcc00;
      color: #000;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    .deleteBtn {
      background: #e74c3c;
      color: #fff;
    }
    .appCard {
      background: #333;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .appCard img {
      vertical-align: middle;
      margin-right: 10px;
    }
    #vipSettings {
      display: none;
    }
    code {
      background: #000;
      padding: 2px 6px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>üõ† IpaVip Admin Panel</h1>
  <form id="appForm">
    <select id="repoType">
      <option value="apps">–û–±—ã—á–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π</option>
      <option value="vipApps">VIP —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (—Ç–æ–∫–µ–Ω)</option>
    </select>
    <input type="text" id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required />
    <input type="text" id="bundleID" placeholder="Bundle ID" required />
    <input type="text" id="version" placeholder="–í–µ—Ä—Å–∏—è" required />
    <input type="number" id="size" placeholder="–†–∞–∑–º–µ—Ä (–≤ –±–∞–π—Ç–∞—Ö)" required />
    <input type="text" id="downloadURL" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ IPA" required />
    <input type="text" id="iconURL" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∫–æ–Ω–∫—É" required />
    <textarea id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>

    <div id="vipSettings">
      <label>üìÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:</label>
      <input type="datetime-local" id="expireDate" />
    </div>

    <button type="submit">üíæ –î–æ–±–∞–≤–∏—Ç—å</button>
  </form>

  <div id="tokenOutput"></div>
  <div id="appsList"></div>
</body>
</html>
